# Gokkan Keeper (ê³³ê°„ ì§€ê¸°)

> **Keeps an eye on what matters.**  
> ë‹¹ì‹ ì˜ ìì‚°ì„ ëŒ€ì‹  ì‚´í´ë³´ëŠ” ê³³ê°„ ì§€ê¸°

---

## ğŸ§­ What is Gokkan Keeper?

**Gokkan Keeper(ê³³ê°„ ì§€ê¸°)** ëŠ”  
í©ì–´ì§„ ê³„ì¢Œì™€ ìì‚°ì„ **ëª©ì ë³„ â€˜ê³³ê°„â€™** ìœ¼ë¡œ ëª¨ì•„  
ì‚¶ì˜ ìì‚° êµ¬ì¡°ë¥¼ **í•œëˆˆì— ì´í•´í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” ê°œì¸ ìì‚° ê¸°ë¡ ë„êµ¬**ì…ë‹ˆë‹¤.

ì´ ì„œë¹„ìŠ¤ëŠ” ê±°ë˜ë¥¼ ê¶Œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.  
ëŒ€ì‹ , **ì§€ì¼œë³´ê³  Â· ê¸°ë¡í•˜ê³  Â· ì •ë¦¬í•´ì£¼ëŠ” ì—­í• **ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.

> ë¹„ìƒê¸ˆì€ ë¹„ìƒê¸ˆë‹µê²Œ,  
> ê°€ê³„ ìì‚°ì€ ê°€ê³„ ìì‚°ë‹µê²Œ,  
> ì•„ì´ë“¤ ìì‚°ì€ ì•„ì´ë“¤ ìì‚°ë‹µê²Œ.

---

## ğŸ¤” Why Gokkan Keeper?

ëŒ€ë¶€ë¶„ì˜ ìì‚° ê´€ë¦¬ ì„œë¹„ìŠ¤ëŠ”  
- ê³„ì¢Œ ë‹¨ìœ„ë¡œ í©ì–´ì ¸ ìˆê³ 
- ì¦ì€ í™•ì¸ê³¼ ê±°ë˜ë¥¼ ìœ ë„í•˜ë©°
- â€œì–¼ë§ˆ ë²Œì—ˆëŠ”ì§€â€ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.

Gokkan KeeperëŠ” ì§ˆë¬¸ì„ ë°”ê¿‰ë‹ˆë‹¤.

- ë‚´ ë¹„ìƒê¸ˆì€ **ì œ ì—­í• ì„ í•˜ê³  ìˆëŠ”ê°€?**
- ì½”ì¸ì´ ì „ì²´ ìì‚°ì„ **í”ë“¤ê³  ìˆì§€ëŠ” ì•Šì€ê°€?**
- ì•„ì´ë“¤ ìì‚°ì€ **ìŠíˆì§€ ì•Šê³  ê´€ë¦¬ë˜ê³  ìˆëŠ”ê°€?**

ğŸ‘‰ **ê´€ë¦¬ì˜ ê¸°ì¤€ì„ â€˜ê³„ì¢Œâ€™ê°€ ì•„ë‹ˆë¼ â€˜ëª©ì â€™ìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤.**

---

## ğŸ  Core Concept: Granary (ê³³ê°„)

Gokkan Keeperì—ì„œ ìì‚°ì€ ë‹¤ìŒê³¼ ê°™ì´ ê´€ë¦¬ë©ë‹ˆë‹¤.

- **ê³³ê°„(Granary)**  
  ìì‚°ì˜ *ëª©ì  ë‹¨ìœ„*  
  (ì˜ˆ: ë¹„ìƒê¸ˆ ê³³ê°„, ê°€ê³„ ê³³ê°„, ì½”ì¸ ê³³ê°„, ì•„ì´ë“¤ ê³³ê°„)

- **ê³³ê°„ ì§€ê¸°(Keeper)**  
  ìì‚°ì„ ëŒ€ì‹  ì‚´í´ë³´ê³ ,  
  ìƒíƒœë¥¼ ìš”ì•½í•˜ê³ ,  
  ì˜¤ë˜ ì—´ë¦¬ì§€ ì•Šì€ ê³³ê°„ì„ ì•Œë ¤ì£¼ëŠ” ì¡´ì¬

---

## âœï¸ What You Track (MVP ê¸°ì¤€)

Gokkan KeeperëŠ” **ìµœì†Œí•œì˜ ë°ì´í„°ë§Œ ê¸°ë¡**í•©ë‹ˆë‹¤.

- ë‚ ì§œ
- ê³„ì¢Œ(ë˜ëŠ” ê³³ê°„)
- ì´ í‰ê°€ ê¸ˆì•¡ (í†µí™” í¬í•¨)

ì„ íƒì ìœ¼ë¡œ:
- ì˜ˆìˆ˜ê¸ˆ
- ê°„ë‹¨í•œ ë©”ëª¨

> ì¢…ëª© Â· ë§¤ìˆ˜ë‹¨ê°€ Â· ê±°ë˜ë‚´ì—­ì€ í•„ìˆ˜ê°€ ì•„ë‹™ë‹ˆë‹¤.  
> **â€˜ê´€ë¦¬ë˜ëŠ” ìƒíƒœâ€™ë¥¼ ë§Œë“œëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.**

---

## ğŸ” Tracking Rhythm (ê¶Œì¥ ì£¼ê¸°)

- **ë¹„ìƒê¸ˆ / ê°€ê³„ ìì‚°**: ì›” 1~2íšŒ
- **ì½”ì¸**: ì£¼ 1íšŒ (ë˜ëŠ” ìë™ ìŠ¤ëƒ…ìƒ·)
- **ì•„ì´ë“¤ ìì‚°**: ë¶„ê¸° 1íšŒ

ğŸ‘‰ ì›” **6~10íšŒ ì…ë ¥**ì´ë©´  
â€œê´€ë¦¬ë˜ê³  ìˆë‹¤â€ë¼ê³  ë§í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.

---

## ğŸ›  Tech Stack (MVP)

- **Frontend**: Vite + React (Capacitor-ready)
- **Backend**: Cloudflare Workers (Hono)
- **Database**: Cloudflare D1 (SQLite)
- **Storage**: Cloudflare R2 (CSV ë“±)
- **Cron**: Workers Cron Trigger
- **Auth**: Shared secret (Single-user MVP)

> ì¸í”„ë¼ë³´ë‹¤ **ì§€ì† ê°€ëŠ¥í•œ ê¸°ë¡**ì„ ìš°ì„ í•©ë‹ˆë‹¤.

---

## ğŸ“‚ Repository Structure

```
gokkan-keeper/
apps/
web/ # Frontend
api/ # Backend (Workers)
packages/
shared/ # types, utils, copy
migrations/ # DB migrations
wrangler.toml
```


---

## ğŸ§  Design Philosophy

- **Less data, more insight**
- **Observe, donâ€™t trade**
- **Purpose over accounts**
- **Family-friendly by default**

Gokkan KeeperëŠ”  
ìˆ«ìë¥¼ ì¤„ì´ê³ ,  
êµ¬ì¡°ë¥¼ ë“œëŸ¬ë‚´ë©°,  
ì‚¶ì˜ ì¤‘ì‹¬ì„ ì§€í‚¤ëŠ” ë„êµ¬ê°€ ë˜ê³ ì í•©ë‹ˆë‹¤.

---

## ğŸš§ Status

- [x] Domain & concept defined
- [x] Core data model
- [x] Manual snapshot input
- [x] Granary status summary (Gokkan Keeper voice)
- [ ] Upbit auto snapshot (Phase 2)
- [ ] Accounts table (Phase 2)

---

## ğŸ“œ License

Apache License 2.0  
(Planned)

---

---

## ğŸš€ Getting Started

### Prerequisites

- Node.js 18.20.0 (recommended: use nvm)
- pnpm 8+
- Cloudflare account (for Workers, D1, R2)

### Installation

#### Step 1: Install Node.js (using nvm)

```bash
# Install and switch to the correct Node.js version
nvm install 18.20.0  # If version is not installed
nvm use               # Switch to the version specified in .nvmrc
```

#### Step 2: Install pnpm

If pnpm is not installed, choose one of the following methods:

**Option A: Using Corepack (recommended, comes with Node.js)**
```bash
corepack enable
corepack prepare pnpm@latest --activate
```

**Option B: Using npm**
```bash
npm install -g pnpm
```

**Option C: Using standalone script**
```bash
curl -fsSL https://get.pnpm.io/install.sh | sh -
```

Verify installation:
```bash
pnpm --version  # Should show 8.x or higher
```

#### Step 3: Install project dependencies

```bash
# Install dependencies
pnpm install

# Build shared package
pnpm --filter shared build
```

**Quick Setup (all steps at once):**
```bash
nvm install 18.20.0 && nvm use
corepack enable && corepack prepare pnpm@latest --activate
pnpm install && pnpm --filter shared build
```

**Note**: This project uses `.nvmrc` to specify Node.js version. If you're using nvm:
- If you see "N/A: version is not yet installed", run `nvm install 18.20.0` first
- Then run `nvm use` to switch to the correct version
- This ensures all developers use the same Node.js version

### Development

**Before running `pnpm dev`, make sure you've set up environment variables** (see Environment Variables section below).

```bash
# Run frontend and backend in development mode
pnpm dev

# Frontend: http://localhost:5173
# Backend: http://localhost:8787
```

**Quick setup for first-time development:**
```bash
# 1. Set up backend environment variables
cd apps/api
cp .dev.vars.example .dev.vars
# Edit .dev.vars and set API_SECRET

# 2. Set up frontend environment variables
cd ../web
echo "VITE_API_BASE_URL=http://localhost:8787" > .env
echo "VITE_API_SECRET=your-secret-key-here" >> .env
# Edit .env and set VITE_API_SECRET to match API_SECRET

# 3. Go back to root and run dev
cd ../..
pnpm dev
```

### Environment Variables

**âš ï¸ Important**: Before running `pnpm dev`, you must set up environment variables.

#### Backend (API) - `.dev.vars` file

Create `apps/api/.dev.vars` file for local development:

```bash
cd apps/api
cp .dev.vars.example .dev.vars
# Edit .dev.vars and set your API_SECRET
```

Content of `apps/api/.dev.vars`:
```env
API_SECRET=your-secret-key-here-change-in-production
```

**Note**: `.dev.vars` is used by `wrangler dev` for local development. This file is gitignored for security.

#### Frontend (Web) - `.env` file

Create `apps/web/.env` file:

```bash
cd apps/web
# Create .env file with the following content
```

Content of `apps/web/.env`:
```env
VITE_API_BASE_URL=http://localhost:8787
VITE_API_SECRET=your-secret-key-here-change-in-production
```

**Important**: 
- The `VITE_API_SECRET` must match the `API_SECRET` in `apps/api/.dev.vars`
- Both files are gitignored for security
- For production, set these in your deployment platform's environment variables

### Database Setup

#### How D1 Works Locally

**Cloudflare D1** is Cloudflare's serverless SQLite database service. For local development:

- **Production**: Uses Cloudflare's managed D1 service in the cloud
- **Local Development**: `wrangler dev` creates a local SQLite file (in `.wrangler/state/`) that simulates D1
- The local SQLite file is completely separate from production - your local data won't affect production and vice versa
- You need to run migrations with `--local` flag to create tables in the local SQLite file

**Where is the local database?**
- Location: `.wrangler/state/v3/d1/miniflare-D1DatabaseObject/`
- This is a regular SQLite file that you can inspect with SQLite tools if needed
- The file is gitignored (in `.gitignore`)

#### For Local Development

**Option 1: Using npx (works without pnpm in PATH)**
```bash
# From project root
cd apps/api
npx wrangler d1 migrations apply shared-db --local
```

**Option 2: From root directory (if pnpm is available)**
```bash
# From project root
pnpm --filter api migrate:local
```

**Option 3: Enable corepack first (if pnpm command not found)**
```bash
# Enable corepack (if not already enabled)
corepack enable

# Then try again
cd apps/api
pnpm migrate:local
```

**Quick fix if pnpm is not found:**
```bash
# Just use npx directly - no pnpm needed
cd apps/api
npx wrangler d1 migrations apply shared-db --local
```

**Important Notes**:
- Run `migrate:local` **before** or **after** starting `wrangler dev` - both work
- If you see "no such table" errors, run `migrate:local` to create the tables
- The local database persists between `wrangler dev` sessions (unless you delete `.wrangler/` folder)

#### For Production

**Note**: Cloudflare D1 free plan allows up to 5 databases. This project uses table prefixes (`gk_`) to allow sharing a single database across multiple services.

```bash
cd apps/api

# Create D1 database (first time only)
# If you already have a database for other services, you can reuse it
wrangler d1 create shared-db

# Update database_id in apps/api/wrangler.toml with the returned database_id

# Run migrations (--remote flag required for production)
pnpm migrate
# Or: pnpm wrangler d1 migrations apply shared-db --remote
# Or: npx wrangler d1 migrations apply shared-db --remote
```

**Using existing database:**

If you already have a D1 database for other services, simply update `database_id` in `wrangler.toml` to use that database. Table names use `gk_` prefix (`gk_granaries`, `gk_snapshots`) to avoid conflicts with other services.

### Deployment

#### Pre-deployment Checklist

- [ ] Shared package built: `pnpm --filter shared build`
- [ ] All tests passing (if any)
- [ ] Environment variables configured
- [ ] D1 database created and migrated
- [ ] API_SECRET generated and secured
- [ ] Domain/subdomain configured (if using custom domain)

#### Step 1: Build All Packages

```bash
# Build shared package first
pnpm --filter shared build

# Build frontend and backend
pnpm build
```

#### Step 2: Create Production D1 Database

```bash
cd apps/api

# Create D1 database (first time only)
pnpm wrangler d1 create shared-db
# ë˜ëŠ”: npx wrangler d1 create shared-db

# Copy the returned database_id and update apps/api/wrangler.toml:
# database_id = "your-actual-database-id-here"

# Run migrations on production database
wrangler d1 migrations apply shared-db
```

#### Step 3: Configure Production Environment Variables

**Backend (Cloudflare Workers)**:

Set secrets in Cloudflare Dashboard or via CLI:

```bash
cd apps/api

# Set API_SECRET as a secret (recommended)
wrangler secret put API_SECRET
# Enter your production API_SECRET when prompted

# Or set in wrangler.toml [env.production.vars] (less secure, not recommended for secrets)
```

**Frontend**:

Set environment variables in your hosting platform:
- `VITE_API_BASE_URL`: Your production API URL (e.g., `https://api.gokkan-keeper.com`)
- `VITE_API_SECRET`: Must match backend `API_SECRET`

#### Step 4: Deploy Backend (Cloudflare Workers)

```bash
cd apps/api

# Deploy to production
wrangler deploy --env production
```

**Note**: If using custom subdomain, ensure:
1. Domain is added to Cloudflare
2. DNS is configured
3. `wrangler.toml` has correct route configuration

#### Step 5: Deploy Frontend

**Option A: Static Hosting (Vercel, Netlify, Cloudflare Pages, etc.)**

```bash
cd apps/web

# Build for production
pnpm build

# Deploy dist/ folder to your hosting service
# Configure environment variables in hosting platform dashboard
```

**Option B: Manual Deployment**

```bash
cd apps/web
pnpm build

# Upload dist/ folder contents to your web server
# Ensure environment variables are set in your hosting environment
```

#### Step 6: Verify Deployment

1. Check backend health: `https://your-api-domain.com/health`
2. Test API endpoints with correct `X-API-Secret` header
3. Verify frontend can connect to API
4. Test creating granaries and snapshots

#### Post-deployment

- [ ] Test all core features (create granary, create snapshot, edit, etc.)
- [ ] Verify API authentication works
- [ ] Check CORS configuration
- [ ] Monitor error logs
- [ ] Set up Cloudflare Access (recommended for production security)

### Production Security

**âš ï¸ Important**: For production deployments, it's strongly recommended to use **Cloudflare Access** in addition to shared secret authentication:

- Shared secret provides basic authentication
- Cloudflare Access adds identity-based access control
- Configure Access policies to restrict API access to authorized users
- This provides defense-in-depth security for your personal asset data

### Mobile App (Capacitor)

```bash
cd apps/web

# Sync Capacitor
pnpm cap:sync

# Open iOS/Android project
pnpm cap:ios
pnpm cap:android
```

---

## ğŸ“„ License

MIT License - see [LICENSE](LICENSE) file for details.

---

## âœ¨ Closing

> ìì‚°ì„ í†µì œí•˜ì§€ ì•Šì•„ë„ ê´œì°®ìŠµë‹ˆë‹¤.  
> **ì§€ì¼œë³´ê³  ìˆë‹¤ëŠ” ê°ê°**ì´ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.

Gokkan Keeper is your quiet companion  
that keeps an eye on your granary.
